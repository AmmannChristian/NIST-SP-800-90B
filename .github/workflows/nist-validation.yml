name: NIST Scientific Validation

on:
  workflow_dispatch:  # Only run manually for NIST reference comparison

env:
  PROTOC_VERSION: '28.3'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.4'

    - name: Cache NIST reference repository and binaries
      uses: actions/cache@v4
      with:
        path: |
          build/90b-validation/ref
          build/90b-validation/bin
        key: nist-validation-${{ runner.os }}-${{ hashFiles('tools/run_90b_validation.sh') }}
        restore-keys: |
          nist-validation-${{ runner.os }}-

    - name: Cache protoc
      id: cache-protoc
      uses: actions/cache@v4
      with:
        path: ${{ runner.temp }}/protoc
        key: protoc-${{ env.PROTOC_VERSION }}-${{ runner.os }}-${{ runner.arch }}

    - name: Install protoc
      if: steps.cache-protoc.outputs.cache-hit != 'true'
      run: |
        wget -q "https://github.com/protocolbuffers/protobuf/releases/download/v${{ env.PROTOC_VERSION }}/protoc-${{ env.PROTOC_VERSION }}-linux-x86_64.zip"
        unzip -q protoc-${{ env.PROTOC_VERSION }}-linux-x86_64.zip -d "${{ runner.temp }}/protoc"

    - name: Add protoc to PATH
      run: echo "${{ runner.temp }}/protoc/bin" >> "$GITHUB_PATH"

    - name: Install C++ Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          g++ \
          make \
          libbz2-dev \
          libdivsufsort-dev \
          libjsoncpp-dev \
          libmpfr-dev \
          libgmp-dev \
          libssl-dev

    - name: Build NIST C++ Library
      run: make build-nist

    - name: Download Go dependencies
      run: go mod download

    - name: Install Go protobuf tools
      run: |
        go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
        go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

    - name: Run NIST Validation
      id: validation
      run: |
        ./tools/run_90b_validation.sh | tee validation_output.txt

        # Capture validation results for summary
        echo "## NIST Scientific Validation Results" > $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat validation_output.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Upload Validation Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: validation-results
        path: |
          build/90b-validation/ref_*.json
          build/90b-validation/go_*.json
          validation_output.txt
        retention-days: 30
        if-no-files-found: warn
